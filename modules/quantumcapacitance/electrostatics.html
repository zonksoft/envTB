

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>quantumcapacitance.electrostatics &mdash; EnvTB 1 documentation</title>
    
    <link rel="stylesheet" href="../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../static/jquery.js"></script>
    <script type="text/javascript" src="../../static/underscore.js"></script>
    <script type="text/javascript" src="../../static/doctools.js"></script>
    <link rel="top" title="EnvTB 1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">EnvTB 1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for quantumcapacitance.electrostatics</h1><div class="highlight"><pre>
<span class="c">#Mind coordinate system: first coordinate goes down (=row number), second to the right (=column number)</span>
<span class="c">#Mind usage: creatematrix() checks possible new boundary conditions (i.e. fixed voltage somewhere), createinhomogeneity() does not (=faster).</span>
<span class="c">#Mind grid points: assume that a grid point is in the top left corner of its &quot;grid area&quot;</span>

<span class="c">#TODO: container-plot data function doesnt work for more complicated arrangements</span>
<span class="c">#TODO: in Element Operatoranwendung und matrixelementherstellung trennen</span>
<span class="c">#TODO: periodische selbstverbindung moeglich machen; oder extra option &quot;periodisch&quot; mit spiegelungsoption?</span>
<span class="c">#TODO: index-funktion von Element auch fuern Container machen</span>
<span class="c">#TODO: speicherung des operators spezifisch fuer jedes rechteck macht (noch) keinen sinn</span>
<span class="c">#TODO: verbessere fermi_energy/potential kombination</span>
<span class="c">#TODO: sind echte Ladungen korrekt eingebaut? v.a. bei materialabhaengigem laplace? fkt element.inhomogeneity</span>
<span class="c">#TODO: in self consistency cycle &amp; self consistency solver wird fermi_energy eig als fermi_energy/q benutzt, naemlich als spannung</span>
<span class="c">#TODO: gridhoehe ist in graphene bulk DOS hardcodiert!!</span>
<span class="c">#TODO: variablen, die &quot;charge_operator&quot; heissen, sollten das epsilon_0 schon drin haben</span>
<span class="c">#TODO: Container und PeriodicContainer sollten gemergt und vererbt werden</span>
<span class="c">#TODO: zuerst     qcsolver.refresh_environment_contrib(), dann qcsolver.refresh_basisvecs(), sonst falsch - warum?? war nicht reproduzierbar. fkt besser dokumentieren</span>
<span class="c">#TODO: improve documentation of Laplacian2ndOrderWithMaterials</span>
<span class="c">#TODO: expand return value of vector_to_datamatrix with start vector and</span>
<span class="c">#      latticesize for interpolation  </span>
<span class="c">#TODO; make the solution a class which has all the plot and export</span>
<span class="c">#      functions!!!!!11</span>

<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">import</span> <span class="nn">scipy.sparse.linalg</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="c">#import matplotlib</span>
<span class="kn">import</span> <span class="nn">pylab</span>


<div class="viewcode-block" id="Element"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Element">[docs]</a><span class="k">class</span> <span class="nc">Element</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Element describes a single grid point/discretization element in a geometry. </span>
<span class="sd">    It saves the rectangle it belongs to (rect), its position (i,j) within its rectangle.</span>
<span class="sd">    It supplies a function matrixelements() which, given an operator, returns the matrix  </span>
<span class="sd">    elements of the element to its neighbours and the inhomogeneity of the element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#: Row index of Element</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Column index of Element</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">rect</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">__matrixelements</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">__inhomogeneity</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">__inhomogeneityelements</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Electrostatic potential of Element </span>
    <span class="n">potential</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Charge of element</span>
    <span class="n">charge</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Dependence of Fermi energy on charge</span>
    <span class="n">fermi_energy_charge_dependence</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Dependence of charge on Fermi energy</span>
    <span class="n">charge_fermi_energy_dependence</span><span class="o">=</span><span class="bp">None</span>
    <span class="c">#: Electrochemical potential of Element</span>
    <span class="n">fermi_energy</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Dielectric constant of Element</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#: Neumann boundary condition of Element</span>
    <span class="n">neumannbc</span><span class="o">=</span><span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rect</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">potential</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fermi_energy_charge_dependence</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fermi_energy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">neumannbc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">charge_fermi_energy_dependence</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        i: Row index</span>
<span class="sd">        j: Column index</span>
<span class="sd">        potential: If potential is None, the element is a normal gridpoint.</span>
<span class="sd">                        Otherwise, the element has a fixed potential (i.e. a metal/a capacitor).</span>
<span class="sd">        charge: charge of the element. Default is 0. If potential!=None, the charge value </span>
<span class="sd">                will be ignored (metal is not charged).</span>
<span class="sd">        fermi_energy_charge_dependence: How the fermi energy of the material depends on the charge. Default is None.</span>
<span class="sd">                                        Mind that this setting assumes that the element is in a homogeneous environment.</span>
<span class="sd">        charge_fermi_energy_dependence: Like the former, but the other way round.</span>
<span class="sd">        fermi_energy: If the Fermi energy depends on the number of charge carriers, the fermi energy (=applied voltage e.g. by a battery)</span>
<span class="sd">                      can be different from the electrostatic potential. fermi_energy_charge_dependence has to be defined in this case.</span>
<span class="sd">                      Then you can calculate the quantum capacitance of the system.</span>
<span class="sd">                      If fermi_energy_charge_dependence=None, then fermi_energy=potential.</span>
<span class="sd">        epsilon: Relative dielectrical constant.</span>
<span class="sd">        neumannbc: The slope along x or y direction can be fixed, e.g. for a neumann boundary condition.</span>
<span class="sd">                   E.g. neumannbc=(14,&#39;y&#39;) or neumannbc=(0,&#39;x&#39;). neumannbc and potential cannot be used</span>
<span class="sd">                   at the same time. Charge has to be 0 (=default value).</span>
<span class="sd">                   Values != 0 do not seem to work right (see comments).</span>
<span class="sd">                      </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">=</span><span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="o">=</span><span class="n">j</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="o">=</span><span class="n">rect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">=</span><span class="n">potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="o">=</span><span class="n">charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermi_energy_charge_dependence</span><span class="o">=</span><span class="n">fermi_energy_charge_dependence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_fermi_energy_dependence</span><span class="o">=</span><span class="n">charge_fermi_energy_dependence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermi_energy</span><span class="o">=</span><span class="n">fermi_energy</span>
        <span class="k">if</span> <span class="n">fermi_energy</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">fermi_energy</span><span class="o">=</span><span class="n">potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neumannbc</span><span class="o">=</span><span class="n">neumannbc</span>
        
<div class="viewcode-block" id="Element.matrixelements"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Element.matrixelements">[docs]</a>    <span class="k">def</span> <span class="nf">matrixelements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the matrix elements of the current element to its neighbours.</span>

<span class="sd">        finitedifference_operator: The discretized operator of the differential equation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">matrixelements</span><span class="o">=</span><span class="p">[(</span><span class="bp">self</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
            <span class="c">#inhomogeneity=self.potential</span>
            <span class="n">inhomogeneityelements</span><span class="o">=</span><span class="mi">0</span> <span class="c">#Variable is not used</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">neumannbc</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slope_operator_1st_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neumannbc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">finitedifference_operator</span><span class="p">)</span>
            <span class="n">matrixelements</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">potential</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
            
            <span class="n">inhomogeneityelements</span><span class="o">=</span><span class="mi">0</span> <span class="c">#Variable is not used</span>
        <span class="k">else</span><span class="p">:</span>               
            <span class="n">elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pure_operator</span><span class="p">(</span><span class="n">finitedifference_operator</span><span class="p">)</span>
            <span class="n">matrixelements</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">potential</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
            <span class="n">inhomogeneityelements</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">potential</span><span class="o">!=</span><span class="bp">None</span><span class="p">]</span> <span class="c">#Implicitly assumes that all elements outside the calculation area have the potential 0</span>
            <span class="c">#inhomogeneity=self.charge/self.epsilon</span>
            <span class="c">#for x,v in inhomogeneityelements:</span>
            <span class="c">#    inhomogeneity-=x.potential*v####################################################</span>
         
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__inhomogeneityelements</span><span class="o">=</span><span class="n">inhomogeneityelements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__matrixelements</span><span class="o">=</span><span class="n">matrixelements</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">inhomogeneity</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__matrixelements</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__inhomogeneity</span>        
    </div>
<div class="viewcode-block" id="Element.inhomogeneity"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Element.inhomogeneity">[docs]</a>    <span class="k">def</span> <span class="nf">inhomogeneity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c">#Implicitly assumes that all elements outside the calculation area have the potential 0, because it just doesn&#39;t handle the outside area</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the inhomogeneity of the element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">inhomogeneity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="o">/</span><span class="n">Constants</span><span class="o">.</span><span class="n">epsilon0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neumannbc</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inhomogeneityelements</span><span class="p">:</span>
                    <span class="n">inhomogeneity</span><span class="o">-=</span><span class="n">x</span><span class="o">.</span><span class="n">potential</span><span class="o">*</span><span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inhomogeneity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neumannbc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inhomogeneity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">potential</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__inhomogeneity</span><span class="o">=</span><span class="n">inhomogeneity</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inhomogeneity</span>
    </div>
    <span class="k">def</span> <span class="nf">slope_operator_1st_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">):</span>
        <span class="c">#there is no epsilon dependency implemented!!</span>
        <span class="k">def</span> <span class="nf">my_neighbours</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">neighbour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">)</span>
 
        <span class="n">denominator</span><span class="o">=</span><span class="n">finitedifference_operator</span><span class="o">.</span><span class="n">dx</span><span class="o">*</span><span class="n">finitedifference_operator</span><span class="o">.</span><span class="n">dy</span> <span class="c">#Probably wrong if dx!=dy - check!! WHY BOTH????</span>
        
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s">&#39;xb&#39;</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="p">[(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s">&#39;xf&#39;</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="p">[(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">)]</span>     
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s">&#39;yb&#39;</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="p">[(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s">&#39;yf&#39;</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="p">[(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">denominator</span><span class="p">)]</span>                       
            
        <span class="n">eps</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">]</span> <span class="c">#is not implemented!!!!!</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="nf">pure_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">my_neighbours</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">neighbour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">finitedifference_operator</span><span class="o">.</span><span class="n">matrixelements</span><span class="p">(</span><span class="n">my_neighbours</span><span class="p">)</span>
                
<div class="viewcode-block" id="Element.index"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Element.index">[docs]</a>    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the index of the element in its rectangle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">pos_to_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">)</span>
        
    </div></div>
<div class="viewcode-block" id="FiniteDifferenceOperator"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.FiniteDifferenceOperator">[docs]</a><span class="k">class</span> <span class="nc">FiniteDifferenceOperator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract basis class for finite difference operators.</span>
<span class="sd">    A class derived from it has to supply variables for dx and dy</span>
<span class="sd">    and a function which returns the matrix elements between the</span>
<span class="sd">    current basis element and its neighbours (see e.g.</span>
<span class="sd">    Laplacian2D2ndOrderWithMaterials)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dx</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">dy</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">matrixelements</span><span class="o">=</span><span class="mi">0</span>
    </div>
<div class="viewcode-block" id="Laplacian2D2ndOrderWithMaterials"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Laplacian2D2ndOrderWithMaterials">[docs]</a><span class="k">class</span> <span class="nc">Laplacian2D2ndOrderWithMaterials</span><span class="p">(</span><span class="n">FiniteDifferenceOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    2nd order discreticed Laplace operator in two dimensions for a</span>
<span class="sd">    electrostatic problem with dielectric materials.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default constructor, dx and dy are the length and width of</span>
<span class="sd">        the element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">=</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="o">=</span><span class="n">dy</span>
                    
<div class="viewcode-block" id="Laplacian2D2ndOrderWithMaterials.matrixelements"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Laplacian2D2ndOrderWithMaterials.matrixelements">[docs]</a>    <span class="k">def</span> <span class="nf">matrixelements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">my_neighbours</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the matrix elements between the main element (i,j)</span>
<span class="sd">        and its neighbours, which are:</span>

<span class="sd">        (i,j) -4</span>
<span class="sd">        (i+1,j) 1</span>
<span class="sd">        (i-1,j) 1</span>
<span class="sd">        (i,j+1) 1</span>

<span class="sd">        ...divided by dx*dy and with a factor describing the dielectric property.</span>

<span class="sd">        my_neighbours: function which returns the element object of a neighbour of the</span>
<span class="sd">                       current element, e.g. my_neighbours(0,0) gibts the current element,</span>
<span class="sd">                       my_neighbours(1,0) the one under it etc.</span>

<span class="sd">             eps1</span>
<span class="sd">        eps2  .  eps3</span>
<span class="sd">             eps4</span>

<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">neighbours</span><span class="o">=</span><span class="p">[</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        
        <span class="n">eps</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">epsilon</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">]</span>
        
        <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="o">-</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">eps</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">eps</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">eps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">eps</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">denominator</span><span class="p">)]</span> <span class="c">#Probably wrong if dx!=dy - check!!</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span>
        <span class="p">]</span>
        
        </div></div>
<div class="viewcode-block" id="Laplacian2D2ndOrder"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Laplacian2D2ndOrder">[docs]</a><span class="k">class</span> <span class="nc">Laplacian2D2ndOrder</span><span class="p">(</span><span class="n">FiniteDifferenceOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    2nd order discreticed Laplace operator in two dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default constructor, dx and dy are the length and width of</span>
<span class="sd">        the element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">=</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="o">=</span><span class="n">dy</span>
                    
<div class="viewcode-block" id="Laplacian2D2ndOrder.matrixelements"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Laplacian2D2ndOrder.matrixelements">[docs]</a>    <span class="k">def</span> <span class="nf">matrixelements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">my_neighbours</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the matrix elements between the main element (i,j)</span>
<span class="sd">        and its neighbours, which are:</span>

<span class="sd">        (i,j) -4</span>
<span class="sd">        (i+1,j) 1</span>
<span class="sd">        (i-1,j) 1</span>
<span class="sd">        (i,j+1) 1</span>

<span class="sd">        ...divided by dx*dy.</span>

<span class="sd">        my_neighbours: function which returns the element object of a neighbour of the</span>
<span class="sd">                       current element, e.g. my_neighbours(0,0) gibts the current element,</span>
<span class="sd">                       my_neighbours(1,0) the one under it etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neighbours</span><span class="o">=</span><span class="p">[</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">my_neighbours</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mf">4.</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">1.</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mf">1.</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mf">1.</span><span class="o">/</span><span class="n">denominator</span><span class="p">),</span>
                <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mf">1.</span><span class="o">/</span><span class="n">denominator</span><span class="p">)]</span> <span class="c">#Probably wrong if dx!=dy - check!!</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span>
        <span class="p">]</span>
    </div></div>
<div class="viewcode-block" id="Rectangle"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Rectangle">[docs]</a><span class="k">class</span> <span class="nc">Rectangle</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rectangle describes a rectangular geometry/grid, containing of mxn elements.</span>
<span class="sd">    It goes through all its element objects and creates the matrices and inhomogeneities,</span>
<span class="sd">    according to the geometry and the boundary conditions, described in the elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elementlist</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">finitedifference_operator</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">m</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">#connected_rectangles=0</span>
    <span class="n">container</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">epsilon</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">fermi_energy_charge_dependence</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        m: Number of rows</span>
<span class="sd">        n: Number of columns</span>
<span class="sd">        epsilon: Relative dielectric constant</span>
<span class="sd">        finitedifference_operator: The operator of the differential equation.</span>
<span class="sd">        fermi_energy_charge_dependence: How the fermi energy of the material depends on the charge. Default is None.</span>
<span class="sd">                                        Mind that this setting assumes that the element is in a homogeneous environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">=</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">=</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="o">=</span><span class="p">[</span><span class="n">Element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span><span class="n">fermi_energy_charge_dependence</span><span class="o">=</span><span class="n">fermi_energy_charge_dependence</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finitedifference_operator</span><span class="o">=</span><span class="n">finitedifference_operator</span>   
    

<div class="viewcode-block" id="Rectangle.neighbour"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Rectangle.neighbour">[docs]</a>    <span class="k">def</span> <span class="nf">neighbour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given coordinates i,j, find out who the neighbour in di,dj direction is.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="ow">and</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rect</span><span class="p">,</span><span class="n">offsets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="o">&gt;=</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="o">&lt;</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span> <span class="ow">and</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="o">&gt;=</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="o">&lt;</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">rect</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">return</span> <span class="bp">None</span>
        </div>
<div class="viewcode-block" id="Rectangle.pos_to_index"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Rectangle.pos_to_index">[docs]</a>    <span class="k">def</span> <span class="nf">pos_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the index of an element at a given position (i,j).</span>
<span class="sd">        The index is a number running from top to bottom, from left to right.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;The Rectangle is smaller than the given coordinates.&quot;</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the element at the given index i,j.</span>

<span class="sd">        Example:</span>
<span class="sd">        element=my_rectangle[3,4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_to_index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

<div class="viewcode-block" id="Rectangle.creatematrices"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Rectangle.creatematrices">[docs]</a>    <span class="k">def</span> <span class="nf">creatematrices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create matrices. The rectangle may be connected with other</span>
<span class="sd">        rectangles (the Container class takes care of that).</span>
<span class="sd">        The function creates the matrices for the interaction with itself</span>
<span class="sd">        and with every other rectangle it is connected to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrices</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">inhomogeneity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">other_rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">matrices</span><span class="p">[</span><span class="n">other_rect</span><span class="p">]</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">other_rect</span><span class="o">.</span><span class="n">elementlist</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="p">:</span>
            <span class="n">idx1</span><span class="o">=</span><span class="n">element</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
            <span class="n">matrixelements</span><span class="p">,</span><span class="n">inhom</span><span class="o">=</span><span class="n">element</span><span class="o">.</span><span class="n">matrixelements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finitedifference_operator</span><span class="p">)</span>
            <span class="n">inhomogeneity</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">=</span><span class="n">inhom</span>
            <span class="k">for</span> <span class="n">elem</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">matrixelements</span><span class="p">:</span>
                <span class="c">#if matrices[elem.rect][idx1,elem.index()]!=0.:</span>
                <span class="c">#    print &quot;already nonzero &quot; + str(idx1)+&quot; &quot;+str(elem.index())</span>
                <span class="n">matrices</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">rect</span><span class="p">][</span><span class="n">idx1</span><span class="p">,</span><span class="n">elem</span><span class="o">.</span><span class="n">index</span><span class="p">()]</span><span class="o">+=</span><span class="n">val</span> <span class="c">#The += is needed when an element influences itself, </span>
                                                            <span class="c">#then a non-diagonal element is added to a diagonal element here.</span>
                                                            <span class="c">#OR if an element is influenced by an other element twice, e.g. from left and right.                    </span>
                                                            <span class="c">#This can be the case for periodic boundary conditions.</span>
        <span class="k">return</span> <span class="n">matrices</span><span class="p">,</span><span class="n">inhomogeneity</span>
    </div>
<div class="viewcode-block" id="Rectangle.createinhomogeneity"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Rectangle.createinhomogeneity">[docs]</a>    <span class="k">def</span> <span class="nf">createinhomogeneity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the inhomogeneity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inhomogeneity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementlist</span><span class="p">:</span>
            <span class="n">inhom</span><span class="o">=</span><span class="n">element</span><span class="o">.</span><span class="n">inhomogeneity</span><span class="p">()</span>
            <span class="n">inhomogeneity</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">index</span><span class="p">()]</span><span class="o">=</span><span class="n">inhom</span>
        <span class="k">return</span> <span class="n">inhomogeneity</span>
    </div></div>
<div class="viewcode-block" id="PeriodicContainer"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer">[docs]</a><span class="k">class</span> <span class="nc">PeriodicContainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains a single rectangle which is periodically repeated in one direction.</span>
<span class="sd">    (by placing copies of itself next to it).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rectangle_list</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">rectangle_connections</span><span class="o">=</span><span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rectangle</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        rectangle: The rectangle to repeat.</span>
<span class="sd">        mode: &#39;x&#39;: The rectangle is repeated in x direction only (default).</span>
<span class="sd">              &#39;y&#39;: The rectangle is repeated in y direction only.</span>
<span class="sd">              &#39;xy&#39;:The rectangle is repeated in x and y direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="o">=</span><span class="p">[</span><span class="n">rectangle</span><span class="p">]</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="p">):</span>
        <span class="n">rectangle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rectangle</span><span class="p">][</span><span class="n">rectangle</span><span class="p">]</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">rectangle</span><span class="o">.</span><span class="n">container</span><span class="o">=</span><span class="bp">self</span>
            
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s">&#39;xy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rectangle</span><span class="p">][</span><span class="n">rectangle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="n">rectangle</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rectangle</span><span class="p">][</span><span class="n">rectangle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rectangle</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s">&#39;y&#39;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s">&#39;xy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rectangle</span><span class="p">][</span><span class="n">rectangle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">rectangle</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rectangle</span><span class="p">][</span><span class="n">rectangle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">rectangle</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
            
<span class="c">###########################################################################</span>
<span class="c">###########################################################################</span>
<span class="c">###########################################################################</span>
<span class="c">#Kopie aus Container</span>

    <span class="k">def</span> <span class="nf">rectangle_elementnumbers_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nrrange</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">ctr</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="n">nrrange</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span><span class="n">ctr</span><span class="o">+</span><span class="n">rec</span><span class="o">.</span><span class="n">m</span><span class="o">*</span><span class="n">rec</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">ctr</span><span class="o">+=</span><span class="n">rec</span><span class="o">.</span><span class="n">m</span><span class="o">*</span><span class="n">rec</span><span class="o">.</span><span class="n">n</span>        
        <span class="k">return</span> <span class="n">nrrange</span>        
        
<div class="viewcode-block" id="PeriodicContainer.creatematrix"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.creatematrix">[docs]</a>    <span class="k">def</span> <span class="nf">creatematrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create matrix for the whole container. The solution of the differential</span>
<span class="sd">        equation </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrixarray</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">inhomarray</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="n">matrixarray</span><span class="p">[</span><span class="n">rec</span><span class="p">],</span><span class="n">inhomarray</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">creatematrices</span><span class="p">()</span>
        <span class="n">supermatrix</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">bmat</span><span class="p">([[</span><span class="n">matrixarray</span><span class="p">[</span><span class="n">rec</span><span class="p">][</span><span class="n">other_rec</span><span class="p">]</span> <span class="k">for</span> <span class="n">other_rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">],</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;csc&#39;</span><span class="p">)</span>
        <span class="n">inhomogeneity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">inhomarray</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">supermatrix</span><span class="p">,</span><span class="n">inhomogeneity</span>
    </div>
<div class="viewcode-block" id="PeriodicContainer.createinhomogeneity"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.createinhomogeneity">[docs]</a>    <span class="k">def</span> <span class="nf">createinhomogeneity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create inhomogeneity for the whole container.</span>
<span class="sd">        You can change the boundary condition values (e.g. different voltage) and create</span>
<span class="sd">        the new inhomogeneity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rec</span><span class="o">.</span><span class="n">createinhomogeneity</span><span class="p">()</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">])</span>  
    </div>
<div class="viewcode-block" id="PeriodicContainer.vector_to_datamatrix"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.vector_to_datamatrix">[docs]</a>    <span class="k">def</span> <span class="nf">vector_to_datamatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a data matrix out of a solution vector of this system that can be plotted</span>
<span class="sd">        using imshow().</span>

<span class="sd">        vec: Vector that is a solution for this system.</span>

<span class="sd">        Return:</span>
<span class="sd">        datamatrix: Matrix, plottable with imshow().</span>
<span class="sd">        extent: Plot range parameter for imshow().</span>

<span class="sd">        Example:</span>
<span class="sd">        datamatrix,extent = my_container.vector_to_datamatrix(vec)</span>
<span class="sd">        imshow(data,extent=extent)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">abs_pos</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>
        
        <span class="n">imin</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">other_rect</span><span class="p">,</span><span class="n">offsets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rect</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">offset</span><span class="o">=</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c">#Only &quot;first&quot; position of each rectangle will be considered for plot</span>
                <span class="n">abs_pos</span><span class="p">[</span><span class="n">other_rect</span><span class="p">]</span><span class="o">=</span><span class="n">abs_pos</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">abs_pos</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">rect</span><span class="p">,</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">abs_pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">imin</span><span class="p">,</span><span class="n">imax</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
            <span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">jmin</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">jmax</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            
        <span class="n">extent</span><span class="o">=</span><span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">imin</span>
        
        <span class="n">datamatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">imax</span><span class="o">-</span><span class="n">imin</span><span class="p">,</span><span class="n">jmax</span><span class="o">-</span><span class="n">jmin</span><span class="p">))</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">rectangle_elementnumbers_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_elementnumbers_range</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rect</span><span class="p">,</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">abs_pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">elements</span><span class="o">=</span><span class="n">rectangle_elementnumbers_range</span><span class="p">[</span><span class="n">rect</span><span class="p">]</span>
            <span class="n">datamatrix</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">imin</span><span class="p">:</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">imin</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                       <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">jmin</span><span class="p">:</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">jmin</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">vec</span><span class="p">[</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">datamatrix</span><span class="p">,</span><span class="n">extent</span>
    </div>
<div class="viewcode-block" id="PeriodicContainer.simple_plot"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.simple_plot">[docs]</a>    <span class="k">def</span> <span class="nf">simple_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a simple plot of the solution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="n">datamatrix</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vector_to_datamatrix</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">datamatrix</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="PeriodicContainer.solve_and_plot"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.solve_and_plot">[docs]</a>    <span class="k">def</span> <span class="nf">solve_and_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the system and create a simple plot.        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solve</span><span class="p">,</span><span class="n">inhom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lu_solver</span><span class="p">()</span>
        
        <span class="n">x</span><span class="o">=</span><span class="n">solve</span><span class="p">(</span><span class="n">inhom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_plot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="PeriodicContainer.apply_operator"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.apply_operator">[docs]</a>    <span class="k">def</span> <span class="nf">apply_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">elements</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        vec: Solution vector to apply the operator onto.</span>
<span class="sd">        finitedifference_operator: The operator.</span>
<span class="sd">        elements: Specific elements to apply the operator onto. If None, it is applied</span>
<span class="sd">        to all elements.</span>

<span class="sd">        If the operator includes points which are not within the calculated area</span>
<span class="sd">        (=rectangle + those connected to it), they are implicitly assumed to be zero.</span>

<span class="sd">        Return:</span>
<span class="sd">        result: Result of the operator on the vector. If elements=None (=all elements),</span>
<span class="sd">        this can be plotted with simple_plot().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">elements</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
                <span class="n">elements</span><span class="o">+=</span><span class="n">rect</span><span class="o">.</span><span class="n">elementlist</span>
                
        <span class="n">rectangle_elementnumbers_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_elementnumbers_range</span><span class="p">()</span>
                
        <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">pure_operator</span><span class="p">):</span>
            <span class="n">r</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">elem</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">pure_operator</span><span class="p">:</span>
                <span class="n">r</span><span class="o">+=</span><span class="n">val</span><span class="o">*</span><span class="n">vec</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">index</span><span class="p">()</span><span class="o">+</span><span class="n">rectangle_elementnumbers_range</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">rect</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">r</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">apply</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">pure_operator</span><span class="p">(</span><span class="n">finitedifference_operator</span><span class="p">))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>
    </div>
<div class="viewcode-block" id="PeriodicContainer.charge"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.charge">[docs]</a>    <span class="k">def</span> <span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">elements</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the charge with a given operator.</span>
<span class="sd">        This is a wrapper for apply_operator() which additionally multiplies with \epsilon_0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_operator</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">elements</span><span class="p">)</span><span class="o">*</span><span class="n">Constants</span><span class="o">.</span><span class="n">epsilon0</span>
        </div>
<div class="viewcode-block" id="PeriodicContainer.get_values_at_elements"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.get_values_at_elements">[docs]</a>    <span class="k">def</span> <span class="nf">get_values_at_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">elements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get values of given elements in solution vector.</span>
<span class="sd">        </span>
<span class="sd">        vec: solution vector</span>
<span class="sd">        elements: list of elements to get the solution at</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">rectangle_elementnumbers_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_elementnumbers_range</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">vec</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">index</span><span class="p">()</span><span class="o">+</span><span class="n">rectangle_elementnumbers_range</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">rect</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> 
         <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">]</span>
        </div>
<div class="viewcode-block" id="PeriodicContainer.lu_solver"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.PeriodicContainer.lu_solver">[docs]</a>    <span class="k">def</span> <span class="nf">lu_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the system matrix and solve the system by LU decomposition.</span>

<span class="sd">        Return:</span>
<span class="sd">        solver: Function that gives the solution x for a given inhomogenity b.</span>
<span class="sd">        inhomogeneity: Inhomogeneity of the current configuration.</span>

<span class="sd">        Example:</span>
<span class="sd">        solver,inhomogeneity=my_container.lu_solver()</span>
<span class="sd">        x=solver(inhomogeneity)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">matrix</span><span class="p">,</span><span class="n">inhomogeneity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creatematrix</span><span class="p">()</span>
        <span class="n">solve</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">solve</span><span class="p">,</span><span class="n">inhomogeneity</span>
<span class="c">###########################################################################</span>
<span class="c">###########################################################################</span>
<span class="c">###########################################################################</span>
</div></div>
<div class="viewcode-block" id="Container"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container">[docs]</a><span class="k">class</span> <span class="nc">Container</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container contains one or more rectangles and is responsible for gathering</span>
<span class="sd">    the submatrices and sub-inhomogeneities created by the Rectangle objects,</span>
<span class="sd">    putting them into one matrix/vector and solving the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rectangle_list</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">rectangle_connections</span><span class="o">=</span><span class="mi">0</span>
    
<div class="viewcode-block" id="Container.connect"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rect</span><span class="p">,</span><span class="n">other_rect</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">viceversa</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The connect function sets the relationship of one rectangle in the container to an other</span>
<span class="sd">        rectangle.</span>

<span class="sd">        align: How the other rectangle is aligned relative to the first rectangle.</span>
<span class="sd">        Possible values are &#39;top&#39;,&#39;bottom&#39;,&#39;left&#39; and &#39;right&#39;.</span>
<span class="sd">        position: Position of the other rectangle relative to the first rectangle.</span>
<span class="sd">        Possible values are &#39;top&#39;,&#39;bottom&#39;,&#39;left&#39; and &#39;right&#39;.</span>
<span class="sd">        offset: offset vector in lattice units, starting from the position given by align and position</span>
<span class="sd">        viceversa: equally connect other rectangle automatically. Default is True.</span>

<span class="sd">        Examples: align=&#39;top&#39;,position=&#39;right&#39;: the tops of the rectangles will be aligned, and the other</span>
<span class="sd">                  rectangle is right of the current one.</span>
<span class="sd">                  align=&#39;right&#39;,position=&#39;bottom&#39;: the right sides of the rectangles will be aligned,</span>
<span class="sd">                  and the other rectangle is below the first rectangle.</span>

<span class="sd">        align=&#39;top&#39; or &#39;bottom&#39; have to be combined with position=&#39;right&#39; or &#39;left&#39; and vice versa!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">totaloffset</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">align</span><span class="o">==</span><span class="s">&#39;top&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">align</span><span class="o">==</span><span class="s">&#39;bottom&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="o">-</span><span class="n">other_rect</span><span class="o">.</span><span class="n">m</span>
        <span class="k">if</span> <span class="n">align</span><span class="o">==</span><span class="s">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">align</span><span class="o">==</span><span class="s">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="n">other_rect</span><span class="o">.</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;top&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=-</span><span class="n">other_rect</span><span class="o">.</span><span class="n">m</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;bottom&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="n">other_rect</span><span class="o">.</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">totaloffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span>
            
        <span class="n">totaloffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">totaloffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="n">other_rect</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">totaloffset</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">viceversa</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;top&#39;</span><span class="p">:</span>
                <span class="n">other_position</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;bottom&#39;</span><span class="p">:</span>
                <span class="n">other_position</span><span class="o">=</span><span class="s">&#39;top&#39;</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;left&#39;</span><span class="p">:</span>
                <span class="n">other_position</span><span class="o">=</span><span class="s">&#39;right&#39;</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">==</span><span class="s">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">other_position</span><span class="o">=</span><span class="s">&#39;left&#39;</span>                
            
            <span class="n">other_offset</span><span class="o">=-</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">other_rect</span><span class="p">,</span><span class="n">rect</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="n">align</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="n">other_position</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">other_offset</span><span class="p">,</span><span class="n">viceversa</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rectangle_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        rectangle_list: List of rectangles participating in the calculation.</span>

<span class="sd">        Invoke connect() afterwards to set the connection between the rectangles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rectangle_list</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="n">rect</span><span class="p">]</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">rect</span><span class="o">.</span><span class="n">container</span><span class="o">=</span><span class="bp">self</span>
    
<div class="viewcode-block" id="Container.add_rectangle"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.add_rectangle">[docs]</a>    <span class="k">def</span> <span class="nf">add_rectangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an additional rectangle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="n">rect</span><span class="p">]</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">rect</span><span class="o">.</span><span class="n">container</span><span class="o">=</span><span class="bp">self</span>
        </div>
    <span class="k">def</span> <span class="nf">rectangle_elementnumbers_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nrrange</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">ctr</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="n">nrrange</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span><span class="n">ctr</span><span class="o">+</span><span class="n">rec</span><span class="o">.</span><span class="n">m</span><span class="o">*</span><span class="n">rec</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">ctr</span><span class="o">+=</span><span class="n">rec</span><span class="o">.</span><span class="n">m</span><span class="o">*</span><span class="n">rec</span><span class="o">.</span><span class="n">n</span>        
        <span class="k">return</span> <span class="n">nrrange</span>        
        
<div class="viewcode-block" id="Container.creatematrix"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.creatematrix">[docs]</a>    <span class="k">def</span> <span class="nf">creatematrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create matrix for the whole container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrixarray</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">inhomarray</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="n">matrixarray</span><span class="p">[</span><span class="n">rec</span><span class="p">],</span><span class="n">inhomarray</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">creatematrices</span><span class="p">()</span>
        <span class="n">supermatrix</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">bmat</span><span class="p">([[</span><span class="n">matrixarray</span><span class="p">[</span><span class="n">rec</span><span class="p">][</span><span class="n">other_rec</span><span class="p">]</span> <span class="k">for</span> <span class="n">other_rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">],</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;csc&#39;</span><span class="p">)</span>
        <span class="n">inhomogeneity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">inhomarray</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">supermatrix</span><span class="p">,</span><span class="n">inhomogeneity</span>
    </div>
<div class="viewcode-block" id="Container.createinhomogeneity"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.createinhomogeneity">[docs]</a>    <span class="k">def</span> <span class="nf">createinhomogeneity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create inhomogeneity for the whole container.</span>
<span class="sd">        You can change the boundary condition values (e.g. different voltage) and create</span>
<span class="sd">        the new inhomogeneity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rec</span><span class="o">.</span><span class="n">createinhomogeneity</span><span class="p">()</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">])</span>  
    </div>
<div class="viewcode-block" id="Container.vector_to_datamatrix"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.vector_to_datamatrix">[docs]</a>    <span class="k">def</span> <span class="nf">vector_to_datamatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a data matrix out of a solution vector of this system that can be plotted</span>
<span class="sd">        using imshow() or used for export.</span>

<span class="sd">        vec: Vector that is a solution for this system.</span>

<span class="sd">        Return:</span>
<span class="sd">        datamatrix: Matrix, plottable with imshow().</span>
<span class="sd">        extent: Plot range parameter for imshow().</span>

<span class="sd">        Example:</span>
<span class="sd">        datamatrix,extent = my_container.vector_to_datamatrix(vec)</span>
<span class="sd">        imshow(data,extent=extent)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">abs_pos</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>
        
        <span class="n">imin</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">other_rect</span><span class="p">,</span><span class="n">offsets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_connections</span><span class="p">[</span><span class="n">rect</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">offset</span><span class="o">=</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c">#Only &quot;first&quot; position of each rectangle will be considered for plot</span>
                <span class="n">abs_pos</span><span class="p">[</span><span class="n">other_rect</span><span class="p">]</span><span class="o">=</span><span class="n">abs_pos</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">abs_pos</span><span class="p">[</span><span class="n">rect</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">rect</span><span class="p">,</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">abs_pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">imin</span><span class="p">,</span><span class="n">imax</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
            <span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">jmin</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">jmax</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            
        <span class="n">extent</span><span class="o">=</span><span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">imin</span>
        
        <span class="n">datamatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">imax</span><span class="o">-</span><span class="n">imin</span><span class="p">,</span><span class="n">jmax</span><span class="o">-</span><span class="n">jmin</span><span class="p">))</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">rectangle_elementnumbers_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_elementnumbers_range</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rect</span><span class="p">,</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">abs_pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">elements</span><span class="o">=</span><span class="n">rectangle_elementnumbers_range</span><span class="p">[</span><span class="n">rect</span><span class="p">]</span>
            <span class="n">datamatrix</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">imin</span><span class="p">:</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">imin</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                       <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">jmin</span><span class="p">:</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">jmin</span><span class="o">+</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">vec</span><span class="p">[</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">rect</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">datamatrix</span><span class="p">,</span><span class="n">extent</span>
    </div>
<div class="viewcode-block" id="Container.simple_plot"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.simple_plot">[docs]</a>    <span class="k">def</span> <span class="nf">simple_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a simple plot of the solution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="n">datamatrix</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vector_to_datamatrix</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">datamatrix</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Container.solve_and_plot"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.solve_and_plot">[docs]</a>    <span class="k">def</span> <span class="nf">solve_and_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the system and create a simple plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">solve</span><span class="p">,</span><span class="n">inhom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lu_solver</span><span class="p">()</span>
        
        <span class="n">x</span><span class="o">=</span><span class="n">solve</span><span class="p">(</span><span class="n">inhom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_plot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Container.apply_operator"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.apply_operator">[docs]</a>    <span class="k">def</span> <span class="nf">apply_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">elements</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        vec: Solution vector to apply the operator onto.</span>
<span class="sd">        finitedifference_operator: The operator.</span>
<span class="sd">        elements: Specific elements to apply the operator onto. If None, it is applied</span>
<span class="sd">        to all elements.</span>

<span class="sd">        If the operator includes points which are not within the calculated area</span>
<span class="sd">        (=rectangle + those connected to it), they are implicitly assumed to be zero.</span>

<span class="sd">        Return:</span>
<span class="sd">        result: Result of the operator on the vector. If elements=None (=all elements),</span>
<span class="sd">        this can be plotted with simple_plot().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">elements</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_list</span><span class="p">:</span>
                <span class="n">elements</span><span class="o">+=</span><span class="n">rect</span><span class="o">.</span><span class="n">elementlist</span>
                
        <span class="n">rectangle_elementnumbers_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rectangle_elementnumbers_range</span><span class="p">()</span>
                
        <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">pure_operator</span><span class="p">):</span>
            <span class="n">r</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">elem</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">pure_operator</span><span class="p">:</span>
                <span class="n">r</span><span class="o">+=</span><span class="n">val</span><span class="o">*</span><span class="n">vec</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">index</span><span class="p">()</span><span class="o">+</span><span class="n">rectangle_elementnumbers_range</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">rect</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">r</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">apply</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">pure_operator</span><span class="p">(</span><span class="n">finitedifference_operator</span><span class="p">))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>
    </div>
<div class="viewcode-block" id="Container.charge"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.charge">[docs]</a>    <span class="k">def</span> <span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">elements</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the charge with a given operator.</span>
<span class="sd">        This is a wrapper for apply_operator() which additionally multiplies with \epsilon_0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_operator</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">finitedifference_operator</span><span class="p">,</span><span class="n">elements</span><span class="p">)</span><span class="o">*</span><span class="n">Constants</span><span class="o">.</span><span class="n">epsilon0</span>
        
        </div>
<div class="viewcode-block" id="Container.lu_solver"><a class="viewcode-back" href="../../electrostatics.html#quantumcapacitance.electrostatics.Container.lu_solver">[docs]</a>    <span class="k">def</span> <span class="nf">lu_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the system matrix and solve the system by LU decomposition.</span>

<span class="sd">        Return:</span>
<span class="sd">        solver: Function that gives the solution x for a given inhomogenity b.</span>
<span class="sd">        inhomogeneity: Inhomogeneity of the current configuration.</span>

<span class="sd">        Example:</span>
<span class="sd">        solver,inhomogeneity=my_container.lu_solver()</span>
<span class="sd">        x=solver(inhomogeneity)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">matrix</span><span class="p">,</span><span class="n">inhomogeneity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creatematrix</span><span class="p">()</span>
        <span class="n">solve</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">solve</span><span class="p">,</span><span class="n">inhomogeneity</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">EnvTB 1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Rafael Reiter.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>